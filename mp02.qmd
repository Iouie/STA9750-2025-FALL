---
title: "Mini-Project 02 - Making Backyards Affordable for All"
author: "Stanley Louie"
date: "`r format(Sys.time(), '%B %d, %Y')`"
format:
  html:
    toc: true
    code-fold: true
---

## Introduction

A suitable introduction goes here. In this mini-project, I intend to demonstrate
my skills at Data Integration/Data Visualization/Metric Creation in an analysis of Official Statistics/Economic Data/Census Data data.

## Data Acquisition and Preparation

Grabbing data from US Census Bureau.

```{r}
if(!dir.exists(file.path("data", "mp02"))){
    dir.create(file.path("data", "mp02"), showWarnings=FALSE, recursive=TRUE)
}

library <- function(pkg){
    ## Mask base::library() to automatically install packages if needed
    ## Masking is important here so downlit picks up packages and links
    ## to documentation
    pkg <- as.character(substitute(pkg))
    options(repos = c(CRAN = "https://cloud.r-project.org"))
    if(!require(pkg, character.only=TRUE, quietly=TRUE)) install.packages(pkg)
    stopifnot(require(pkg, character.only=TRUE, quietly=TRUE))
}
library(dplyr)
library(tidyverse)
library(glue)
library(readxl)
library(tidycensus)
library(ggplot2)
library(gghighlight)
library(scales)
library(DT)

get_acs_all_years <- function(variable, geography="cbsa",
                              start_year=2009, end_year=2023){
    fname <- glue("{variable}_{geography}_{start_year}_{end_year}.csv")
    fname <- file.path("data", "mp02", fname)
    
    if(!file.exists(fname)){
        YEARS <- seq(start_year, end_year)
        YEARS <- YEARS[YEARS != 2020] # Drop 2020 - No survey (covid)
        
        ALL_DATA <- map(YEARS, function(yy){
            tidycensus::get_acs(geography, variable, year=yy, survey="acs1") |>
                mutate(year=yy) |>
                select(-moe, -variable) |>
                rename(!!variable := estimate)
        }) |> bind_rows()
        
        write_csv(ALL_DATA, fname)
    }
    
    read_csv(fname, show_col_types=FALSE)
}

# Household income (12 month)
INCOME <- get_acs_all_years("B19013_001") |>
    rename(household_income = B19013_001)

# Monthly rent
RENT <- get_acs_all_years("B25064_001") |>
    rename(monthly_rent = B25064_001)

# Total population
POPULATION <- get_acs_all_years("B01003_001") |>
    rename(population = B01003_001)

# Total number of households
HOUSEHOLDS <- get_acs_all_years("B11001_001") |>
    rename(households = B11001_001)
```

Manually grabbing number of new housing units built each year

```{r}
get_building_permits <- function(start_year = 2009, end_year = 2023){
    fname <- glue("housing_units_{start_year}_{end_year}.csv")
    fname <- file.path("data", "mp02", fname)
    
    if(!file.exists(fname)){
        HISTORICAL_YEARS <- seq(start_year, 2018)
        
        HISTORICAL_DATA <- map(HISTORICAL_YEARS, function(yy){
            historical_url <- glue("https://www.census.gov/construction/bps/txt/tb3u{yy}.txt")
                
            LINES <- readLines(historical_url)[-c(1:11)]

            CBSA_LINES <- str_detect(LINES, "^[[:digit:]]")
            CBSA <- as.integer(str_sub(LINES[CBSA_LINES], 5, 10))

            PERMIT_LINES <- str_detect(str_sub(LINES, 48, 53), "[[:digit:]]")
            PERMITS <- as.integer(str_sub(LINES[PERMIT_LINES], 48, 53))
            
            data_frame(CBSA = CBSA,
                       new_housing_units_permitted = PERMITS, 
                       year = yy)
        }) |> bind_rows()
        
        CURRENT_YEARS <- seq(2019, end_year)
        
        CURRENT_DATA <- map(CURRENT_YEARS, function(yy){
            current_url <- glue("https://www.census.gov/construction/bps/xls/msaannual_{yy}99.xls")
            
            temp <- tempfile()
            
            download.file(current_url, destfile = temp, mode="wb")
            
            fallback <- function(.f1, .f2){
                function(...){
                    tryCatch(.f1(...), 
                             error=function(e) .f2(...))
                }
            }
            
            reader <- fallback(read_xlsx, read_xls)
            
            reader(temp, skip=5) |>
                na.omit() |>
                select(CBSA, Total) |>
                mutate(year = yy) |>
                rename(new_housing_units_permitted = Total)
        }) |> bind_rows()
        
        ALL_DATA <- rbind(HISTORICAL_DATA, CURRENT_DATA)
        
        write_csv(ALL_DATA, fname)
        
    }
    
    read_csv(fname, show_col_types=FALSE)
}

PERMITS <- get_building_permits()
```


BLS data NAICS coding system

```{r}
library(httr2)
library(rvest)
get_bls_industry_codes <- function(){
    fname <- fname <- file.path("data", "mp02", "bls_industry_codes.csv")
    
    if(!file.exists(fname)){
    
        resp <- request("https://www.bls.gov") |> 
            req_url_path("cew", "classifications", "industry", "industry-titles.htm") |>
            req_headers(`User-Agent` = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:143.0) Gecko/20100101 Firefox/143.0") |> 
            req_error(is_error = \(resp) FALSE) |>
            req_perform()
        
        resp_check_status(resp)
        
        naics_table <- resp_body_html(resp) |>
            html_element("#naics_titles") |> 
            html_table() |>
            mutate(title = str_trim(str_remove(str_remove(`Industry Title`, Code), "NAICS"))) |>
            select(-`Industry Title`) |>
            mutate(depth = if_else(nchar(Code) <= 5, nchar(Code) - 1, NA)) |>
            filter(!is.na(depth))
        
        naics_table <- naics_table |> 
            filter(depth == 4) |> 
            rename(level4_title=title) |> 
            mutate(level1_code = str_sub(Code, end=2), 
                   level2_code = str_sub(Code, end=3), 
                   level3_code = str_sub(Code, end=4)) |>
            left_join(naics_table, join_by(level1_code == Code)) |>
            rename(level1_title=title) |>
            left_join(naics_table, join_by(level2_code == Code)) |>
            rename(level2_title=title) |>
            left_join(naics_table, join_by(level3_code == Code)) |>
            rename(level3_title=title) |>
            select(-starts_with("depth")) |>
            rename(level4_code = Code) |>
            select(level1_title, level2_title, level3_title, level4_title, 
                   level1_code,  level2_code,  level3_code,  level4_code)
    
        write_csv(naics_table, fname)
    }
    
    read_csv(fname, show_col_types=FALSE)
    
}

INDUSTRY_CODES <- get_bls_industry_codes()
```


BLS QUARTERLY CENSUS

```{r}
library(httr2)
library(rvest)
get_bls_qcew_annual_averages <- function(start_year=2009, end_year=2023){
    fname <- glue("bls_qcew_{start_year}_{end_year}.csv.gz")
    fname <- file.path("data", "mp02", fname)
    
    YEARS <- seq(start_year, end_year)
    YEARS <- YEARS[YEARS != 2020] # Drop Covid year to match ACS
    
    if(!file.exists(fname)){
        ALL_DATA <- map(YEARS, .progress=TRUE, possibly(function(yy){
            fname_inner <- file.path("data", "mp02", glue("{yy}_qcew_annual_singlefile.zip"))
            
            if(!file.exists(fname_inner)){
                request("https://www.bls.gov") |> 
                    req_url_path("cew", "data", "files", yy, "csv",
                                 glue("{yy}_annual_singlefile.zip")) |>
                    req_headers(`User-Agent` = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:143.0) Gecko/20100101 Firefox/143.0") |> 
                    req_retry(max_tries=5) |>
                    req_perform(fname_inner)
            }
            
            if(file.info(fname_inner)$size < 755e5){
                warning(sQuote(fname_inner), "appears corrupted. Please delete and retry this step.")
            }
            
            read_csv(fname_inner, 
                     show_col_types=FALSE) |> 
                mutate(YEAR = yy) |>
                select(area_fips, 
                       industry_code, 
                       annual_avg_emplvl, 
                       total_annual_wages, 
                       YEAR) |>
                filter(nchar(industry_code) <= 5, 
                       str_starts(area_fips, "C")) |>
                filter(str_detect(industry_code, "-", negate=TRUE)) |>
                mutate(FIPS = area_fips, 
                       INDUSTRY = as.integer(industry_code), 
                       EMPLOYMENT = as.integer(annual_avg_emplvl), 
                       TOTAL_WAGES = total_annual_wages) |>
                select(-area_fips, 
                       -industry_code, 
                       -annual_avg_emplvl, 
                       -total_annual_wages) |>
                # 10 is a special value: "all industries" , so omit
                filter(INDUSTRY != 10) |> 
                mutate(AVG_WAGE = TOTAL_WAGES / EMPLOYMENT)
        })) |> bind_rows()
        
        write_csv(ALL_DATA, fname)
    }
    
    ALL_DATA <- read_csv(fname, show_col_types=FALSE)
    
    ALL_DATA_YEARS <- unique(ALL_DATA$YEAR)
    
    YEARS_DIFF <- setdiff(YEARS, ALL_DATA_YEARS)
    
    if(length(YEARS_DIFF) > 0){
        stop("Download failed for the following years: ", YEARS_DIFF, 
             ". Please delete intermediate files and try again.")
    }
    
    ALL_DATA
}

WAGES <- get_bls_qcew_annual_averages()
```


JOINS household, household income, population, rent

```{r}
combined_data <- inner_join(HOUSEHOLDS, INCOME, by=c("GEOID", "NAME", "year")) |>
    inner_join(POPULATION, by=c("GEOID", "NAME", "year")) |>
    inner_join(RENT, by=c("GEOID", "NAME", "year")) |>
    inner_join(PERMITS, by=c("GEOID" = "CBSA", "year")) |>
    mutate(std_cbsa = paste0("C", GEOID))

WAGES <- WAGES |>
    mutate(std_cbsa = paste0(FIPS, "0"))
```



## Exploratory Analysis

Which CBSA (by name) permitted the largest number of new housing units in the decade from 2010 to 2019 (inclusive)?

```{r}
largest_units <- combined_data |>
    filter(year >= 2010, year <= 2019) |>
    group_by(GEOID) |>
    summarize(total_permitted = sum(new_housing_units_permitted, na.rm=TRUE)) |>
    arrange(desc(total_permitted)) |>
    slice_head(n=1) 
```
* From 2010 to 2019, the CBSA that permitted the largest number of new housing units is 	
**26420** with a total of ***482,075*** units permitted.

In what year did Albuquerque, NM (CBSA Number 10740) permit the most new housing units?
```{r}
abq_max_year <- combined_data |>
    filter(GEOID == 10740) |>
    arrange(desc(new_housing_units_permitted)) |>
    slice_head(n=1)
```
* Albuquerque, NM (CBSA Number 10740) permitted the most new housing units in the year **2021** with ***4,021*** units permitted.

Which state (not CBSA) had the highest average individual income in 2015? To answer this question, you will need to first compute the total income per CBSA by multiplying the average household income by the number of households, and then sum total income and total population across all CBSAs in a state. With these numbers, you can answer this question.

```{r}
state_income_2015 <- combined_data |>
    filter(year == 2015) |>
    mutate(total_income = household_income * households) |>
    mutate(state = str_extract(NAME, ", (.{2})", group=1)) |>
    group_by(state) |>
    summarize(total_income = sum(total_income, na.rm=TRUE),
              total_population = sum(population, na.rm=TRUE)) |>
    mutate(average_individual_income = total_income / total_population) |>
    arrange(desc(average_individual_income)) |>
    slice_head(n=1)
```
* The state with the highest average individual income in 2015 is **DC** with an average individual income of ***$33,232.88***.

Data scientists and business analysts are recorded under NAICS code 5182. What is the last year in which the NYC CBSA had the most data scientists in the country? In recent, the San Francisco CBSA has had the most data scientists.
For this question, you may simply create a table of which CBSA had the most data scientists each year and then answer the question in the following text.

```{r}
areas <- combined_data |> select(NAME,std_cbsa)

data_sci <- WAGES |> 
    filter(INDUSTRY == 5182) |> 
    group_by(YEAR,std_cbsa) |> filter(EMPLOYMENT !=0) |> 
    summarise(max_employment = max(EMPLOYMENT, na.rm = TRUE)) |> 
    slice_max(order_by = max_employment)

#join table to get the city
data_sci <- inner_join(data_sci, areas, by = "std_cbsa") |> distinct()

#code for table
```
* The last year in which the NYC CBSA had the most data scientists in the country was **2015**.

What fraction of total wages in the NYC CBSA was earned by people employed in the finance and insurance industries (NAICS code 52)? In what year did this fraction peak?

```{r}
# get the sum of total wages in NYC cbsa per year
total_wages_sum <- WAGES |> 
    filter(std_cbsa == "C35620") |> group_by(YEAR) |> summarise(sum_total_wages = sum(TOTAL_WAGES))

# get the sum of financial wages in NYC cbsa per year
financial_wages_sum <- WAGES |> 
    filter(std_cbsa == "C35620", str_starts(as.character(INDUSTRY), "52")) |> 
    group_by(YEAR) |> summarise(sum_financial_wages = sum(TOTAL_WAGES))

# join both and calculate fraction
wage_fraction <- inner_join(total_wages_sum, financial_wages_sum, by = "YEAR") |>
    mutate(fraction_of_financial_wages = sum_financial_wages / sum_total_wages) |> arrange(desc(fraction_of_financial_wages))

# getting the total fraction
total_fraction <- wage_fraction |> summarise(fraction_total = sum(sum_financial_wages) / sum(sum_total_wages) * 100)

```
* The fraction of total wages in the NYC CBSA earned by people employed in the finance and insurance industries is ***13.29%***. This fraction peaked in the year **2021** with a fraction of ***15.45%***.

## Task 3

The relationship between monthly rent and average household income per CBSA in 2009.

```{r}
p1 <- ggplot(combined_data |> filter(year == 2009), 
             aes(x = household_income, y = monthly_rent)) +
    geom_point(alpha = 0.6, color="blue") +
    geom_smooth(method = "lm", color = "#F7B800") +
    labs(title = "Relationship between Monthly Rent and Average Household Income (2009)",
         x = "Average Household Income",
         y = "Monthly Rent",
        caption = "Source: US Census Bureau ACS") +
    theme_grey( base_size = 18) + 
    scale_x_continuous(labels = scales::dollar_format()) +
    scale_y_continuous(labels = scales::dollar_format()) +
    theme(plot.title = element_text(size = 12, face = "bold"),
          plot.caption = element_text(size = 5),
          axis.title = element_text(size = 9),
          axis.text = element_text(size = 7))

print(p1)
```

* The scatter plot shows a strong positive relationship between household income and monthly rent in 2009. Metro areas tend to have higher average household incomes which results in higher monthly rents. The linear regression line indicates that as household income increases, monthly rent also tends to increase.

The relationship between total employment and total employment in the health care and social services sector (NAICS 62) across different CBSAs. Design your visualization so that it is possible to see the evolution of this relationship over time.
```{r}
# get the total employment per year per cbsa
emp_total <- WAGES |> 
    group_by(YEAR) |> 
  summarise(total_employment = sum(EMPLOYMENT)) |> 
    ungroup()

# get total employment of health
health_total <- WAGES |> 
    filter(str_starts(as.character(INDUSTRY), "62")) |> 
    group_by(YEAR) |> 
    summarise(health_employment = sum(EMPLOYMENT)) |>
    ungroup()
# join both and calculate fraction
grouped_emp <- inner_join(emp_total, health_total, by = "YEAR") |> 
    mutate(fraction_health_employment = health_employment / total_employment)

p2 <- ggplot(grouped_emp, aes(x= YEAR, y =fraction_health_employment)) +
    geom_line(size = 0.8, color = "#F7B800") +
    geom_point(color = "blue") +
    labs(title = "Total and Health Employment Percantage over time",
         x = "Year",
         y = "Percentage of Health Employment to Total Employment",
         caption = "Source: BLS QCEW") +
    theme_grey(base_size = 18) + 
    scale_y_continuous(labels = scales::percent_format(accuarcy = 1)) +
    theme(plot.title = element_text(size = 12, face = "bold"),
          plot.caption = element_text(size = 5),
          axis.title = element_text(size = 9),
          axis.text = element_text(size = 7))

print(p2)
```

* The plot shows an increase of percentage of Health Employees to Total Employees over time. This indicates that the health care and social services sector has been growing in the economy. There was noticeable growth from 2019 to 2021 due to the pandemic.

The evolution of average household size over time. Use different lines to represent different CBSAs.

```{r}
p3 <- ggplot(combined_data, aes(x= year, y = population / households, 
                                group = GEOID, 
                                color =case_when(GEOID == 35620 ~ "New York",
                                                 GEOID == 31080 ~ "Los Angeles"))) +
    geom_line(linewidth = 0.8) +
   scale_color_manual(values = c("New York" = "#F7B800", "Los Angeles" = "green"),
                     name = "City") +
  gghighlight(GEOID %in% c(35620, 31080), 
              use_direct_label = FALSE, 
              unhighlighted_params = list(alpha=0.5)) +
    labs(title = "Average Household Size over Time by CBSA",
         x = "Year",
         y = "Average Household Size",
         caption = "Source: US Census Bureau ACS") +
    theme_grey(base_size = 18) + 
    theme(plot.title = element_text(size = 12, face = "bold"),
          plot.caption = element_text(size = 5),
          axis.title = element_text(size = 9),
          axis.text = element_text(size = 7))

print(p3)
```

* The plot shows the average household size over time for different CBSAs, with a focus on New York and Los Angeles. Both cities show a slight decrease in average household size over the years, indicating a trend towards smaller households in these metropolitan areas.

## Rent Burden
```{r}
rent_burden_data <- inner_join(INCOME, RENT, by=c("GEOID", "NAME", "year")) |>
    mutate(yearly_rent = monthly_rent * 12,
    rent_burden_percent = yearly_rent/ household_income * 100)

# scaling it
lowest_burden <- min(rent_burden_data$rent_burden_percent, na.rm = TRUE)
highest_burden <- max(rent_burden_data$rent_burden_percent, na.rm = TRUE)

# creating rbi
rent_burden_data <- rent_burden_data |>
    mutate(rbi = 100 * (rent_burden_percent - lowest_burden ) / (highest_burden - lowest_burden))
```

* Rent burden is used to measure percentage of income spent on rent. I've standardized the metric so that 0 would be the lowest burden and 100 would be the highest in the observed data.

## Metropolitan California
```{r}
cali_rent_burden <- rent_burden_data |>
    filter(str_detect(NAME, "Los Angeles")) |>
  select( 'Year' = year,
          'Monthly Rent' = monthly_rent,
          'Household Income' = household_income,
          'Rent Burden Percent' = rent_burden_percent,
          'Rent Burden Score' = rbi) |> 
  mutate(`Monthly Rent` = scales::dollar(`Monthly Rent`),
         `Household Income` = scales::dollar(`Household Income`),
         `Rent Burden Percent` = scales::percent(`Rent Burden Percent` / 100, accuracy = 0.1),
         `Rent Burden Score` = round(`Rent Burden Score`, 2))



datatable(cali_rent_burden,
          class = "table table-striped table-hover table-dark table-sm",
          caption = "Los Angeles Rent Burden 2009-2023",
          options = list(pageLength = 15,
                         autoWidth = TRUE,
                         searching = FALSE))
        
```
* Los Angeles has seen a small increase in rent burden from 2009 to 2023, with the Rent Burden Score rising from approximately **47.26** in 2009 to **52.91** in 2023 while drastically increasing in Household Income. The rent burden has been in the range from **24%** to **26%**.

## Highest and Lowest Metro Burden Areas
```{r}
low_burden <- rent_burden_data |>
    filter(year == 2023, str_detect(NAME, "Metro")) |>
    select(
      'City' = NAME, 
      'Year' = year, 
      'Rent Burden Percent' = rent_burden_percent, 
      'Rent Burden Score' = rbi) |>
    mutate(`Rent Burden Percent` = scales::percent(`Rent Burden Percent` / 100, accuracy = 0.1),
           `Rent Burden Score` = round(`Rent Burden Score`, 2)) |>
    arrange(desc(`Rent Burden Score`)) |> arrange(`Rent Burden Score`) |>
    head(10) 
    
datatable(
  low_burden,
  caption = "Top 10 Lowest Rent Burden Metro Areas in 2023",
  class = "table table-striped table-hover table-dark table-sm",
  options = list(pageLength = 10,
                 autoWidth = TRUE,
                 searching = FALSE)
)
```
* The lowest rent burden score is **Bismarck, North Dakota** with a **5.27** rent burden score with residents spending only **13.7%** of their income on rent.


## Final Insights and Deliverable

Code related to the final deliverable of the assignment goes here. 



------------------------------------------------------------------------

This work Â©2025 by iouie was initially prepared as a Mini-Project for
STA 9750 at Baruch College. More details about this course can be found at
[the course site](https://michael-weylandt.com/STA9750) and instructions for
this assignment can be found at 
[MP #02](https://michael-weylandt.com/STA9750/miniprojects/mini02.html)
